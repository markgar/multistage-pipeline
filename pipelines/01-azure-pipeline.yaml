trigger:
  branches:
    include:
    - master
  
stages:

######################################################################################
- stage: build_artifact
  displayName: Build ARM Template Artifact

  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Build.SourcesDirectory)/arm' 
        artifactName: 'drop'

######################################################################################
- stage: test_artifact
  displayName: Test ARM Template

  jobs:
  - job: Test
    displayName: Test
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - task: DownloadBuildArtifacts@0
      displayName: 'Download Artifact'
      inputs:
        artifactName: drop
    - task: AzureResourceManagerTemplateDeployment@3
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: 'Mark Garner - Internal Consumption(75ebdae9-6e1c-4baa-8b2e-5576f6356a91)'
        subscriptionId: '75ebdae9-6e1c-4baa-8b2e-5576f6356a91'
        action: 'Create Or Update Resource Group'
        resourceGroupName: 'multistage-pipeline-dev'
        location: 'Central US'
        templateLocation: 'Linked artifact'
        csmFile: '$(pipeline.workspace)/drop/azuredeploy.json'
        deploymentMode: 'Validate'
    - powershell: Install-Module Pester -Force
      displayName: 'Install Pester'
    - powershell: |
            $parameters = @{ TemplateFile = ".\azuredeloy.json" }
            $script = @{ Path = "tests/simple.tests.ps1"; Parameters = $parameters }
            Invoke-Pester -Script $script -OutputFile TEST-simple.xml -OutputFormat NUnitXML

            $script = @{ Path = "tests/another.tests.ps1"; Parameters = $parameters }
            Invoke-Pester -Script $script -OutputFile TEST-simple.xml -OutputFormat NUnitXML
      displayName: 'Invoke Pester'
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'NUnit'
        testResultsFiles: '**/TEST-*.xml'

######################################################################################
- stage: deploy_to_dev
  displayName: Deploy to Dev
  dependsOn: test_artifact
  condition: succeeded()

  jobs:
  - deployment: deploy_to_dev
    displayName: Deploy to Development
    environment: 'development'
    pool:
      vmImage: 'ubuntu-latest'

    strategy:
      runOnce:
        deploy:

          steps:
          - task: AzureResourceManagerTemplateDeployment@3
            inputs:
              deploymentScope: 'Resource Group'
              azureResourceManagerConnection: 'Mark Garner - Internal Consumption(75ebdae9-6e1c-4baa-8b2e-5576f6356a91)'
              subscriptionId: '75ebdae9-6e1c-4baa-8b2e-5576f6356a91'
              action: 'Create Or Update Resource Group'
              resourceGroupName: 'multistage-pipeline-dev'
              location: 'Central US'
              templateLocation: 'Linked artifact'
              csmFile: '$(pipeline.workspace)/drop/azuredeploy.json'
              deploymentMode: 'Complete'

######################################################################################
- stage: deploy_to_test
  displayName: Deploy to Test
  dependsOn: deploy_to_dev
  condition: succeeded()

  jobs:
  - deployment: deploy_to_test
    displayName: Deploy to Test
    environment: 'test'
    pool:
      vmImage: 'ubuntu-latest'

    strategy:
      runOnce:
        deploy:

          steps:
          - task: AzureResourceManagerTemplateDeployment@3
            inputs:
              deploymentScope: 'Resource Group'
              azureResourceManagerConnection: 'Mark Garner - Internal Consumption(75ebdae9-6e1c-4baa-8b2e-5576f6356a91)'
              subscriptionId: '75ebdae9-6e1c-4baa-8b2e-5576f6356a91'
              action: 'Create Or Update Resource Group'
              resourceGroupName: 'multistage-pipeline-tst'
              location: 'Central US'
              templateLocation: 'Linked artifact'
              csmFile: '$(pipeline.workspace)/drop/azuredeploy.json'
              deploymentMode: 'Complete'
          